<!-- File: src/main/resources/templates/emp-dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Employee Dashboard ‚Äì CaseLine</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f9fafb; }
        header { background: #1f2937; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; }
        .quick-actions { display: flex; gap: 10px; align-items: center; }
        .quick-actions .btn { padding: 10px 20px; font-size: 14px; border: none; border-radius: 8px; cursor: pointer; background: #374151; color: white; border: 1px solid #4b5563; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; }
        .quick-actions .btn:hover { background: #4b5563; border-color: #6b7280; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .quick-actions .btn:active { transform: translateY(0); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .container { max-width: 1100px; margin: 20px auto; padding: 0 20px; }
        .grid { display: flex; flex-wrap: wrap; gap: 20px; }
        .card { flex: 1 1 200px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 6px rgba(0,0,0,0.05); }
        .card h3 { margin: 0; font-size: 16px; color: #6b7280; }
        .card p { font-size: 28px; color: #1f2937; margin: 10px 0 0; }
        .section { margin-top: 40px; }
        .section h2 { font-size: 20px; color: #1f2937; margin-bottom: 10px; }
        .case-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 0 6px rgba(0,0,0,0.05); }
        .case-table th, .case-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .case-table th { background: #f3f4f6; color: #374151; }
        .btn { padding: 6px 12px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; margin-left: 5px; }
        .btn-view { background: #3b82f6; color: white; }
        .btn-post { background: #10b981; color: white; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-active { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-completed { background: #dbeafe; color: #1e40af; }
        .status-on_hold { background: #f3f4f6; color: #374151; }
        .priority-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .priority-high { background: #fee2e2; color: #991b1b; }
        .priority-medium { background: #fef3c7; color: #92400e; }
        .priority-low { background: #d1fae5; color: #065f46; }
        .sidebar { flex: 0 0 300px; }
        .main-content { flex: 1; }
        .content-grid { display: flex; gap: 20px; }
        .notifications-card, .activity-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 6px rgba(0,0,0,0.05); margin-bottom: 20px; max-height: 300px; overflow-y: auto; }
        .notification-item, .activity-item { padding: 10px 0; border-bottom: 1px solid #e5e7eb; }
        .notification-item:last-child, .activity-item:last-child { border-bottom: none; }
        .filter-select { float: right; padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; }
        @media screen and (max-width: 768px) { .grid, .content-grid { flex-direction: column; } }
    </style>
</head>
<body>

<header>
    <h1>üìä CaseLine ‚Äì Employee Dashboard</h1>
    <div class="quick-actions">
        <button class="btn" onclick="viewProfile()">
            <span>üë§</span>
            <span>My Profile</span>
        </button>
    </div>
</header>

<div class="container">

    <!-- Statistics Cards -->
    <div class="grid" id="summary-cards">
        <div class="card">
            <h3>Total Cases</h3>
            <p id="totalCases">...</p>
        </div>
        <div class="card">
            <h3>Active Cases</h3>
            <p id="activeCases">...</p>
        </div>
        <div class="card">
            <h3>Closed Cases</h3>
            <p id="closedCases">...</p>
        </div>
        <div class="card">
            <h3>My Posts</h3>
            <p id="myPosts">...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content-grid">
        <div class="main-content">
            <div class="section">
                <h2>üìÅ Assigned Cases
                    <select class="filter-select" id="filterStatus" onchange="filterCases()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="on_hold">On Hold</option>
                    </select>
                </h2>
                <table class="case-table">
                    <thead>
                    <tr>
                        <th>Case ID</th>
                        <th>Title</th>
                        <th>Case Type</th>
                        <th>Status</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="casesTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Sidebar (kept as static placeholders) -->
        <div class="sidebar">
            <div class="notifications-card">
                <h3>üîî Notifications</h3>
                <div id="notificationsList"></div>
            </div>

            <div class="activity-card">
                <h3>üïê Recent Activity</h3>
                <div id="recentActivity"></div>
            </div>
        </div>
    </div>

</div>

<script>
    // Same header approach as admin_dashboard.html
    function getHeaders() {
        const headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };
        const token = localStorage.getItem('jwt_token');
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        return headers;
    }

    let allCases = [];

    async function loadEmpDashboard() {
        try {
            const response = await fetch('/emp/dashboard', { method: 'GET', headers: getHeaders() });
            if (!response.ok) throw new Error('Failed to load employee dashboard');
            const data = await response.json();

            document.getElementById('totalCases').textContent = data.totalAssignedCases ?? '0';
            document.getElementById('myPosts').textContent = data.totalPosts ?? '0';
            document.getElementById('activeCases').textContent = data.active ?? '0';
            document.getElementById('closedCases').textContent = data.close ?? '0';
        } catch (e) {
            console.error(e);
            document.getElementById('totalCases').textContent = '!';
            document.getElementById('myPosts').textContent = '!';
            document.getElementById('activeCases').textContent = '!';
            document.getElementById('closedCases').textContent = '!';
        }
    }

    async function loadEmpCases() {
        try {
            const response = await fetch('/emp/cases', { method: 'GET', headers: getHeaders() });
            if (!response.ok) throw new Error('Failed to load employee cases');
            allCases = await response.json();
            console.table(response);
            renderCases(allCases);
        } catch (e) {
            console.error(e);
            renderCases([]);
        }
    }

    function renderCases(cases) {
        const table = document.getElementById('casesTable');
        table.innerHTML = '';

        if (!cases || cases.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="6" style="color:#6b7280;">No cases found</td>`;
            table.appendChild(tr);
            return;
        }

        cases.forEach(c => {
            // Try common field names without breaking if null
            const id = c.caseId ?? '';
            const title = c.title ?? '';
            const caseType = (c.caseType ?? '').toString().toLowerCase();
            const status = (c.status ?? '').toString().toLowerCase();
            const createdAt = formatDate(c.createdAt ?? '');

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>#${escapeHtml(id)}</td>
                <td>${escapeHtml(title)}</td>
                <td>${caseType ? `<span class="priority-badge priority-${escapeHtml(caseType)}">${capitalize(caseType)}</span>` : ''}</td>
                <td>${status ? `<span class="status-badge status-${escapeHtml(status)}">${capitalize(status)}</span>` : ''}</td>
                <td>${escapeHtml(createdAt)}</td>
                <td>
                    <button class="btn btn-view" onclick="viewCase('${escapeJs(id)}')">üëÅÔ∏èView</button>
                </td>
            `;
            table.appendChild(tr);
        });
    }

    function filterCases() {
        const status = (document.getElementById('filterStatus').value || '').toLowerCase();
        if (!status) return renderCases(allCases);

        const filtered = (allCases || []).filter(c => {
            const s = (c.status ?? '').toString().toLowerCase();
            return s === status;
        });
        renderCases(filtered);
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const d = new Date(dateString);
        if (Number.isNaN(d.getTime())) return String(dateString);
        return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function capitalize(word) {
        if (!word) return '';
        return word.charAt(0).toUpperCase() + word.slice(1);
    }

    // Minimal escaping for safer DOM usage
    function escapeHtml(value) {
        return String(value)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
    }

    function escapeJs(value) {
        return String(value).replaceAll('\\', '\\\\').replaceAll("'", "\\'");
    }

    function viewCase(caseId) {
        window.location.href = `Case_Profile/${caseId}`;
    }

    function createPost(caseId = null) {
        const url = caseId ? `/create-post?caseId=${caseId}` : '/create-post';
        window.location.href = url;
    }

    function viewProfile() {
        window.location.href = '/profile';
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await loadEmpDashboard();
        await loadEmpCases();
    });
</script>

</body>
</html>